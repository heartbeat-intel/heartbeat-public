---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DarkHeader from '../../components/astro/DarkHeader.astro';
import DarkFooter from '../../components/astro/DarkFooter.astro';
import HotListCard from '../../components/astro/HotListCard.astro';
import CategoryPills from '../../components/astro/CategoryPills.astro';
import PublisherRow from '../../components/astro/PublisherRow.astro';
import LiveFeed from '../../components/astro/LiveFeed.astro';
import TrendingListDark from '../../components/astro/TrendingListDark.astro';
import { fetchTrendingContent, fetchHotLists, fetchAllPublishers } from '../../data/fetch';
import { formatViews } from '../../utils/formatters';
import { API_BASE_URL } from '../../utils/constants';

const trendingContent = await fetchTrendingContent(5);
const hotLists = await fetchHotLists();
const allPublishers = await fetchAllPublishers();

const hasTrending = trendingContent.length > 0;
const hasHotLists = hotLists.length > 0;
const hasPublishers = allPublishers.length > 0;

const feedItems = trendingContent.map((item, i) => ({
  type: (item.contentType === 'article' ? 'update' : 'new_list') as 'new_list' | 'new_subscriber' | 'trending' | 'update',
  text: `${item.author} published "${item.title}"`,
  time: i === 0 ? 'Just now' : `${(i + 1) * 3}m ago`,
}));

const publisherCards = allPublishers.map((publisher) => ({
  id: publisher.id,
  name: publisher.name,
  role: publisher.role,
  specialty: publisher.specialty,
  avatarUrl: publisher.avatarUrl,
  color: publisher.color,
  stats: {
    lists: publisher.stats.lists,
    views: formatViews(publisher.stats.totalViews),
  },
}));

const publisherCount = allPublishers.length;
const pageDescription = `Browse ${publisherCount} intelligence publishers on the Heartbeat Exchange. Subscribe to curated research, market analysis, and proprietary data from verified providers.`;
---

<BaseLayout
  title="Heartbeat Intelligence Exchange — Curated Research & Market Intelligence"
  description={pageDescription}
>
  <DarkHeader variant="exchange" maxWidth="1400px" />

  <main class="pt-16">
    <!-- Publishers — primary content, most SEO value -->
    <section class="max-w-[1400px] mx-auto px-6 pt-10 pb-6" id="publishers" aria-labelledby="exchange-heading">
      <header class="mb-8 max-w-2xl">
        <h1 id="exchange-heading" class="text-3xl md:text-4xl font-bold text-[var(--hb-text-primary)] tracking-tight mb-3">
          Intelligence Exchange
        </h1>
        <p class="text-base text-[var(--hb-text-primary)]/40 leading-relaxed">
          Subscribe to curated intelligence from verified publishers. Get exclusive research, proprietary data, and real-time market insights delivered to your workspace.
        </p>
      </header>

      {hasPublishers && (
        <div class="reveal">
          <PublisherRow publishers={publisherCards} />
        </div>
      )}
    </section>

    <!-- Categories + Trending + Hot Lists -->
    <section class="max-w-[1400px] mx-auto px-6 py-6">
      <div class="bento-grid">
        <!-- Categories -->
        <div class="col-span-12 lg:col-span-4 reveal">
          <div class="glass-card p-5 h-full flex flex-col justify-center">
            <h2 class="text-xs font-bold text-[var(--hb-text-primary)]/30 uppercase tracking-wide mb-3">Browse by Category</h2>
            <CategoryPills />
          </div>
        </div>

        <!-- Trending -->
        <div class="col-span-12 lg:col-span-8 reveal" id="trending" data-reveal-delay="100">
          {hasTrending ? (
            <TrendingListDark items={trendingContent} />
          ) : (
            <div class="glass-card p-6 h-full flex flex-col items-center justify-center text-center min-h-[140px]">
              <svg class="w-7 h-7 text-[var(--hb-text-primary)]/15 mb-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67z" />
              </svg>
              <p class="text-sm text-[var(--hb-text-primary)]/25">Trending content will appear here as publishers share intel.</p>
            </div>
          )}
        </div>

        <!-- Hot Lists -->
        {hasHotLists && hotLists.slice(0, 2).map((list, i) => (
          <div class="col-span-12 md:col-span-6 lg:col-span-4 reveal" data-reveal-delay={String(i * 100)}>
            <HotListCard
              title={list.title}
              description={list.description}
              authorName={list.author || 'Publisher'}
              authorAvatar={undefined}
              subscribers={list.subscribers || 0}
              isHot={list.isHot}
              href={list.publisherId ? `https://${list.publisherId}.${API_BASE_URL}/library/${list.id}` : '#'}
            />
          </div>
        ))}

        <!-- Live Feed + Coming Soon -->
        <div class="col-span-12 lg:col-span-5 reveal">
          <LiveFeed items={feedItems} />
        </div>
        <div class="col-span-12 lg:col-span-7 reveal" data-reveal-delay="100">
          <div class="glass-card p-8 h-full flex flex-col items-center justify-center text-center">
            <div class="w-12 h-12 rounded-full bg-hb-orange-main/10 flex items-center justify-center mb-4">
              <svg class="w-6 h-6 text-hb-orange-main" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </div>
            <h2 class="text-lg font-bold text-[var(--hb-text-primary)] mb-2">More publishers coming soon</h2>
            <p class="text-sm text-[var(--hb-text-primary)]/40 max-w-sm">
              New intelligence providers are onboarding every week. Check back or become a provider yourself.
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <DarkFooter maxWidth="1400px" />
</BaseLayout>
